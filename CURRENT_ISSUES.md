# 机票自动订票系统 - 当前问题与改进方案

## 项目目标
实现类似AutoGLM的自动订票功能，但不用AI，用纯自动化脚本。

## 当前架构
- **前端**: Expo React Native App (SDK 54)
- **核心技术**: WebView + injectedJavaScript
- **支持平台**: 去哪儿、携程、飞猪

## 当前问题

### 1. 数据提取不稳定
**去哪儿** (✅ 工作正常):
```
LOG  [qunar] 找到 1131 个容器元素
LOG  [qunar] 找到 105 个价格，105 个时间对
LOG  [qunar] 提取到 95 个唯一航班
```

**携程** (❌ 提取失败):
```
LOG  [ctrip] 找到 2649 个容器元素
LOG  [ctrip] 找到 272 个价格，0 个时间对  ← 问题：时间格式不匹配
LOG  [ctrip] 提取到 0 个唯一航班
```

**飞猪** (❌ 证书错误):
```
WARN  Encountered an error loading page
code: -1202
description: "此服务器的证书无效"
```

**当前提取逻辑** (results.tsx):
```javascript
// 只匹配 xx:xx 格式的时间
const timeMatches = text.match(/\d{2}:\d{2}/g);
```

**问题**: 携程可能用其他时间格式（如"8时30分"、"08:30"、"830"）

### 2. 自动填表字段识别错误
**现象**: 
- 输入：姓名=张三，身份证=123456
- 结果：身份证号被填到姓名框

**当前逻辑** (booking.tsx):
```javascript
// 按顺序尝试选择器
const nameResult = findInput([
  'input[placeholder*="姓名"]',
  'input[placeholder*="乘机人"]',
  // ...
], passenger.name, '姓名');
```

**问题**: 
- 选择器可能匹配到错误的input
- 验证逻辑不够严格
- 没有排除已填过的字段

### 3. 缺少完整的自动订票流程
**当前流程**:
1. 用户搜索 → 显示航班列表
2. 用户点"订票" → 跳转到WebView
3. 用户手动点击航班 → 自动填表

**缺失的环节**:
- ❌ 如何自动点击用户选择的那个航班？
- ❌ 如何自动进入订票页？
- ❌ 如何自动提交订单？

**理想流程（类似AutoGLM）**:
```
用户: 点击"CA1234 ¥580"
系统: 
  1. 在WebView中找到这个航班（通过航班号+价格）
  2. 自动点击"订票"按钮
  3. 等待跳转到填表页
  4. 自动填写乘客信息
  5. 自动点击"提交订单"
  6. 跳转到支付页（让用户手动支付）
```

## 技术约束
- ✅ 只能用WebView（Expo限制）
- ✅ 只能用injectedJavaScript
- ❌ 不能用Playwright/Puppeteer（需要native build）
- ❌ 不能用Chrome DevTools Protocol
- ✅ 可以为3个平台写死适配规则

## 需要的解决方案

### 方案A: 改进当前WebView方案
**优点**: 不改架构，只优化提取和填表逻辑
**缺点**: 可靠性有限，网站改版就挂

**需要做的**:
1. 改进时间提取正则，支持多种格式
2. 改进表单字段识别，用更智能的启发式规则
3. 实现自动点击航班的逻辑
4. 实现自动提交订单的逻辑

### 方案B: 用平台API（如果有）
**优点**: 最可靠
**缺点**: 去哪儿/携程/飞猪不提供公开API

### 方案C: 混合方案
**搜索**: 用WebView提取数据（当前方案）
**订票**: 用后端Playwright自动化（需要部署服务器）

**问题**: 
- 需要额外的服务器
- Playwright在手机上跑不了

## 问题

1. **如何让WebView自动点击用户选择的航班？**
   - 用户在App中点击"CA1234 ¥580"
   - 如何在WebView中找到并点击这个航班？
   - 不同平台的DOM结构不同，如何适配？

2. **如何改进数据提取的可靠性？**
   - 携程的时间格式是什么？
   - 如何写一个通用的提取逻辑？
   - 要不要为每个平台写专门的提取脚本？

3. **如何改进自动填表的准确性？**
   - 如何避免字段识别错误？
   - 如何验证填写结果？
   - 要不要用机器学习模型？

4. **如何实现完整的自动订票流程？**
   - 自动点击航班 → 自动填表 → 自动提交
   - 每一步如何验证成功？
   - 如何处理验证码、登录等问题？

## 期望的讨论方向

1. **架构选择**: 继续用WebView还是换方案？
2. **提取策略**: 写死3个平台的规则 vs 通用提取逻辑？
3. **自动化程度**: 做到哪一步？（填表 vs 完整订票）
4. **可靠性**: 如何保证不出错？如何处理异常？

## 参考
- AutoGLM: 用AI理解页面，自动操作
- 我们的方案: 不用AI，用规则和启发式算法

---

**请给出你的建议和实现思路。**
